<!-- notas.html -->
<script>
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const estudianteId = urlParams.get('estudianteId');
        cargarNotasEstudiante(estudianteId);
    };

    function cargarNotasEstudiante(estudianteId) {
        fetch(`http://localhost:8080/api/notas?estudianteId=${estudianteId}`)
            .then(response => response.json())
            .then(notas => {
                let trHTML = '';
                notas.forEach(nota => {
                    trHTML += `
          <tr>
            <td>${nota.id}</td>
            <td>${nota.observacion}</td>
            <td>${nota.valor}</td>
            <td>${nota.porcentaje}%</td>
            <td>
              <button type="button" class="btn btn-outline-secondary" onclick="editarNota(${nota.id})">Editar</button>
              <button type="button" class="btn btn-outline-danger" onclick="eliminarNota(${nota.id})">Borrar</button>
            </td>
          </tr>
        `;
                });
                document.getElementById('mytable').innerHTML = trHTML;
            })
            .catch(error => {
                console.error('Error al cargar las notas:', error);
                document.getElementById('mytable').innerHTML = '<tr><td colspan="5">Error al cargar las notas</td></tr>';
            });
    }

    function crearNota() {
        Swal.fire({
            title: 'Crear Nota',
            html:
                '<input id="observacion" class="swal2-input" placeholder="Observación">' +
                '<input id="valor" class="swal2-input" placeholder="Valor">' +
                '<input id="porcentaje" class="swal2-input" placeholder="Porcentaje">',
            focusConfirm: false,
            preConfirm: () => {
                const observacion = document.getElementById('observacion').value;
                const valor = document.getElementById('valor').value;
                const porcentaje = document.getElementById('porcentaje').value;
                const estudianteId = new URLSearchParams(window.location.search).get('estudianteId');
                saveNota({ observacion, valor, porcentaje, estudianteId });
            }
        });
    }

    function editarNota(notaId) {
        fetch(`http://localhost:8080/api/notas/${notaId}`)
            .then(response => response.json())
            .then(nota => {
                Swal.fire({
                    title: 'Editar Nota',
                    html:
                        '<input id="observacion" class="swal2-input" placeholder="Observación" value="' + nota.observacion + '">' +
                        '<input id="valor" class="swal2-input" placeholder="Valor" value="' + nota.valor + '">' +
                        '<input id="porcentaje" class="swal2-input" placeholder="Porcentaje" value="' + nota.porcentaje + '">',
                    focusConfirm: false,
                    preConfirm: () => {
                        const observacion = document.getElementById('observacion').value;
                        const valor = document.getElementById('valor').value;
                        const porcentaje = document.getElementById('porcentaje').value;
                        const estudianteId = new URLSearchParams(window.location.search).get('estudianteId');
                        updateNota(notaId, { observacion, valor, porcentaje, estudianteId });
                    }
                });
            })
            .catch(error => {
                console.error('Error al cargar la nota:', error);
                alert('Ocurrió un error al cargar la nota');
            });
    }

    function eliminarNota(notaId) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar'
        }).then((result) => {
            if (result.isConfirmed) {
                deleteNota(notaId);
            }
        });
    }

    function saveNota(nota) {
        fetch('http://localhost:8080/api/notas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(nota)
        })
            .then(response => {
                if (response.ok) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const estudianteId = urlParams.get('estudianteId');
                    cargarNotasEstudiante(estudianteId);
                    Swal.fire('Nota creada', '', 'success');
                } else {
                    response.json().then(data => {
                        Swal.fire('Error', data.mensaje, 'error');
                    });
                }
            })
            .catch(error => {
                console.error('Error al crear la nota:', error);
                Swal.fire('Error', 'Ocurrió un error al crear la nota', 'error');
            });
    }

    function updateNota(notaId, nota) {
        fetch(`http://localhost:8080/api/notas/${notaId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(nota)
        })
            .then(response => {
                if (response.ok) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const estudianteId = urlParams.get('estudianteId');
                    cargarNotasEstudiante(estudianteId);
                    Swal.fire('Nota actualizada', '', 'success');
                } else {
                    response.json().then(data => {
                        Swal.fire('Error', data.mensaje, 'error');
                    });
                }
            })
            .catch(error => {
                console.error('Error al actualizar la nota:', error);
                Swal.fire('Error', 'Ocurrió un error al actualizar la nota', 'error');
            });
    }

    function deleteNota(notaId) {
        fetch(`http://localhost:8080/api/notas/${notaId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const estudianteId = urlParams.get('estudianteId');
                    cargarNotasEstudiante(estudianteId);
                    Swal.fire('Nota eliminada', '', 'success');
                } else {
                    response.json().then(data => {
                        Swal.fire('Error', data.mensaje, 'error');
                    });
                }
            })
            .catch(error => {
                console.error('Error al eliminar la nota:', error);
                Swal.fire('Error', 'Ocurrió un error al eliminar la nota', 'error');
            });
    }
</script>